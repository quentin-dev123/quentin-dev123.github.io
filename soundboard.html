<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Soundboard</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      padding: 1.5rem;
      background: canvas;
      color: canvastext;
    }
    main {
      max-width: 720px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    header {
      text-align: center;
    }
    form {
      display: grid;
      gap: 0.9rem;
      padding: 1rem;
      border-radius: 0.9rem;
      background: color-mix(in srgb, canvastext 8%, canvas);
      border: 1px solid color-mix(in srgb, canvastext 12%, canvas);
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.95rem;
    }
    input[type="text"],
    input[type="file"] {
      padding: 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid color-mix(in srgb, canvastext 25%, canvas);
      background: canvas;
      color: inherit;
    }
    input[type="file"] {
      padding: 0.35rem;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 0.7rem;
      padding: 0.75rem 1rem;
      font-weight: 600;
      color: white;
      background: #1f73ff;
      transition: opacity 0.2s;
    }
    button:hover {
      opacity: 0.9;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    .controls button {
      background: #e03232;
    }
    .sound-list {
      display: grid;
      gap: 0.9rem;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }
    .sound-btn {
      padding: 1rem;
      border-radius: 0.9rem;
      background: color-mix(in srgb, #1f73ff 75%, canvas);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
      transition: transform 0.15s;
    }
    .sound-btn:active {
      transform: scale(0.97);
    }
    .empty-state {
      padding: 2rem;
      text-align: center;
      border-radius: 1rem;
      border: 1px dashed color-mix(in srgb, canvastext 25%, canvas);
      color: color-mix(in srgb, canvastext 70%, canvas);
    }
    .meta {
      font-size: 0.85rem;
      color: color-mix(in srgb, canvastext 70%, canvas);
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Soundboard</h1>
      <p>Add short sound effects and play them instantly.</p>
    </header>

    <form id="sound-form">
      <label>
        Title
        <input id="title" type="text" placeholder="e.g., Airhorn" required />
      </label>
      <label>
        Sound file
        <input id="file" type="file" accept="audio/*" required />
      </label>
      <button type="submit">Add sound</button>
    </form>

    <section class="controls">
      <span id="storage-stats" class="meta">Total stored: 0 KB</span>
      <button type="button" id="clear-btn">Clear all</button>
    </section>

    <section id="empty-state" class="empty-state">
      No sounds yet. Add your first clip above!
    </section>

    <section id="sound-list" class="sound-list" hidden></section>
  </main>

  <script>
    const STORAGE_KEY = "soundboard-meta";
    const DB_NAME = "SoundboardDB";
    const STORE_NAME = "sounds";
    let db;

    const form = document.getElementById("sound-form");
    const titleInput = document.getElementById("title");
    const fileInput = document.getElementById("file");
    const soundList = document.getElementById("sound-list");
    const emptyState = document.getElementById("empty-state");
    const storageStats = document.getElementById("storage-stats");
    const clearBtn = document.getElementById("clear-btn");

    init();

    async function init() {
      db = await openDB();
      renderSounds();
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const title = titleInput.value.trim();
      const file = fileInput.files[0];
      if (!title || !file) return;

      const id = crypto.randomUUID();
      await saveBlob(id, file);

      const meta = loadMeta();
      meta.push({
        id,
        title,
        type: file.type,
        size: file.size,
        addedAt: Date.now()
      });
      saveMeta(meta);

      form.reset();
      renderSounds();
    });

    clearBtn.addEventListener("click", async () => {
      if (!confirm("Delete all stored sounds? This cannot be undone.")) return;
      await clearStore();
      saveMeta([]);
      renderSounds();
    });

    async function renderSounds() {
      const meta = loadMeta();
      updateStats(meta);
      soundList.innerHTML = "";

      if (!meta.length) {
        emptyState.hidden = false;
        soundList.hidden = true;
        return;
      }

      emptyState.hidden = true;
      soundList.hidden = false;

      meta.forEach(({ id, title, size }) => {
        const btn = document.createElement("button");
        btn.className = "sound-btn";
        btn.textContent = title;
        btn.title = `${title} â€” ${(size / 1024).toFixed(1)} KB`;
        btn.addEventListener("click", () => playSound(id));
        soundList.appendChild(btn);
      });
    }

    function loadMeta() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveMeta(meta) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(meta));
    }

    function updateStats(meta) {
      const totalBytes = meta.reduce((sum, item) => sum + (item.size || 0), 0);
      const kb = totalBytes / 1024;
      storageStats.textContent = `Total stored: ${kb >= 1024 ? (kb / 1024).toFixed(2) + " MB" : kb.toFixed(1) + " KB"} (${meta.length} item${meta.length === 1 ? "" : "s"})`;
    }

    async function playSound(id) {
      try {
        const blob = await getBlob(id);
        if (!blob) {
          alert("Audio data missing. Try re-adding this sound.");
          return;
        }
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();
        audio.addEventListener("ended", () => URL.revokeObjectURL(url), { once: true });
      } catch (error) {
        console.error(error);
        alert("Failed to play sound.");
      }
    }

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onerror = () => reject(request.error);
        request.onupgradeneeded = () => {
          const db = request.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: "id" });
          }
        };
        request.onsuccess = () => resolve(request.result);
      });
    }

    function saveBlob(id, file) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);
        const entry = { id, blob: file };
        const request = store.put(entry);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    function getBlob(id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readonly");
        const store = tx.objectStore(STORE_NAME);
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result ? request.result.blob : null);
        request.onerror = () => reject(request.error);
      });
    }

    function clearStore() {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, "readwrite");
        const store = tx.objectStore(STORE_NAME);
        const request = store.clear();
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
  </script>
</body>
</html>
